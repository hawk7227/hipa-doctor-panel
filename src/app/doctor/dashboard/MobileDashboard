'use client'

import { useEffect, useState, useMemo } from 'react'
import { supabase } from '@/lib/supabase'
import './mobile-first.css'

// ============================================
// TYPES
// ============================================
interface Appointment {
  id: string
  patient_id: string
  status: string
  visit_type: 'video' | 'phone' | 'async' | 'instant' | null
  requested_date_time: string | null
  patients?: {
    first_name?: string | null
    last_name?: string | null
  } | null
  reason?: string | null
  chief_complaint?: string | null
}

// ============================================
// MOBILE-FIRST DASHBOARD
// ============================================
export default function MobileDashboard() {
  const [appointments, setAppointments] = useState<Appointment[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [activeNav, setActiveNav] = useState('home')

  // Stats
  const stats = useMemo(() => {
    const today = new Date().toDateString()
    const todayApts = appointments.filter(apt => {
      if (!apt.requested_date_time) return false
      return new Date(apt.requested_date_time).toDateString() === today
    })
    
    return {
      total: new Set(appointments.map(a => a.patient_id)).size,
      today: todayApts.length,
      pending: todayApts.filter(a => a.status === 'pending').length,
      complete: todayApts.filter(a => a.status === 'completed').length,
    }
  }, [appointments])

  // Today's appointments
  const todaysAppointments = useMemo(() => {
    const today = new Date().toDateString()
    return appointments
      .filter(apt => {
        if (!apt.requested_date_time) return false
        return new Date(apt.requested_date_time).toDateString() === today
      })
      .sort((a, b) => {
        if (!a.requested_date_time || !b.requested_date_time) return 0
        return new Date(a.requested_date_time).getTime() - new Date(b.requested_date_time).getTime()
      })
      .slice(0, 4) // Show first 4
  }, [appointments])

  // Queue
  const queuePatients = useMemo(() => {
    return appointments.filter(a => a.visit_type === 'instant' && a.status === 'pending')
  }, [appointments])

  // Fetch appointments
  useEffect(() => {
    async function fetchData() {
      try {
        setLoading(true)
        setError(null)
        
        const { data, error: fetchError } = await supabase
          .from('appointments')
          .select(`
            *,
            patients (first_name, last_name)
          `)
          .order('requested_date_time', { ascending: true })
        
        if (fetchError) throw fetchError
        setAppointments(data || [])
      } catch (err) {
        console.error('Error:', err)
        setError('Failed to load data')
      } finally {
        setLoading(false)
      }
    }
    
    fetchData()
  }, [])

  // Format time
  const formatTime = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: false 
    })
  }

  // Get status badge class
  const getStatusClass = (status: string) => {
    switch (status) {
      case 'confirmed':
      case 'accepted':
        return 'confirmed'
      case 'pending':
        return 'pending'
      case 'cancelled':
        return 'cancelled'
      default:
        return 'pending'
    }
  }

  // Get mode display
  const getModeDisplay = (visitType: string | null) => {
    switch (visitType) {
      case 'video':
        return { icon: 'ğŸ“¹', label: 'Video' }
      case 'phone':
        return { icon: 'ğŸ“', label: 'Phone' }
      case 'instant':
        return { icon: 'âš¡', label: 'Instant' }
      case 'async':
        return { icon: 'ğŸ“‹', label: 'Async' }
      default:
        return { icon: 'ğŸ“…', label: 'Visit' }
    }
  }

  // Get reason
  const getReason = (apt: Appointment) => {
    return apt.reason || apt.chief_complaint || 'General Visit'
  }

  if (loading) {
    return (
      <div className="mobile-page">
        <div style={{ 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center', 
          height: '100vh',
          color: 'var(--text-secondary)'
        }}>
          Loading dashboard...
        </div>
      </div>
    )
  }

  return (
    <div className="mobile-page">
      {/* Header */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: '16px',
        paddingTop: 'calc(16px + env(safe-area-inset-top))',
        background: 'var(--bg-white)',
        borderBottom: '1px solid var(--border-light)'
      }}>
        <h1 style={{ fontSize: '20px', fontWeight: 700, color: 'var(--text-primary)' }}>
          Dashboard - Dr. Smith
        </h1>
        <div style={{ display: 'flex', gap: '8px' }}>
          <button className="icon-btn">ğŸ”</button>
          <button className="icon-btn" style={{ position: 'relative' }}>
            ğŸ””
            <span style={{
              position: 'absolute',
              top: '-2px',
              right: '-2px',
              width: '8px',
              height: '8px',
              background: 'var(--danger-red)',
              borderRadius: '50%'
            }} />
          </button>
        </div>
      </div>

      {/* Stats Row */}
      <div className="stats-row">
        <div className="stat-card">
          <div className="stat-value blue">{stats.total}</div>
          <div className="stat-label">Patients</div>
        </div>
        <div className="stat-card">
          <div className="stat-value">{stats.today}</div>
          <div className="stat-label">Today</div>
        </div>
        <div className="stat-card">
          <div className="stat-value orange">{stats.pending}</div>
          <div className="stat-label">Pending</div>
        </div>
        <div className="stat-card">
          <div className="stat-value green">{stats.complete}</div>
          <div className="stat-label">Complete</div>
        </div>
      </div>

      {/* Today's Appointments Section */}
      <div className="section-header">
        <h3 className="section-title">Today's Appointments</h3>
        <button className="section-link">View All â†’</button>
      </div>

      {/* Appointments Table */}
      <div className="appointment-table">
        <div className="table-header">
          <span>TIME</span>
          <span>PATIENT</span>
          <span>STATUS</span>
          <span>MODE</span>
        </div>
        
        {todaysAppointments.length > 0 ? (
          todaysAppointments.map(apt => {
            const mode = getModeDisplay(apt.visit_type)
            return (
              <div key={apt.id} className="appointment-row">
                <div className="apt-time">
                  {apt.requested_date_time ? formatTime(apt.requested_date_time) : '--:--'}
                </div>
                <div className="apt-patient">
                  <div className="apt-patient-name">
                    {apt.patients?.first_name} {apt.patients?.last_name}
                  </div>
                  <div className="apt-patient-reason">{getReason(apt)}</div>
                </div>
                <div className="apt-status">
                  <span className={`status-badge ${getStatusClass(apt.status)}`}>
                    {apt.status === 'accepted' ? 'Confirmed' : 
                     apt.status === 'instant' ? 'Queue' :
                     apt.status.charAt(0).toUpperCase() + apt.status.slice(1)}
                  </span>
                </div>
                <div className="mode-indicator">
                  <span>{mode.icon}</span>
                  <span>{mode.label}</span>
                </div>
              </div>
            )
          })
        ) : (
          <div style={{ 
            padding: '40px 20px', 
            textAlign: 'center', 
            color: 'var(--text-muted)' 
          }}>
            No appointments for today
          </div>
        )}
      </div>

      {/* Queue Alert */}
      {queuePatients.length > 0 && (
        <div className="queue-alert">
          <div className="queue-alert-left">
            <span className="queue-alert-icon">âš¡</span>
            <div>
              <div className="queue-alert-text">
                {queuePatients.length} Patient{queuePatients.length > 1 ? 's' : ''} in Queue
              </div>
              <div className="queue-alert-sub">
                {queuePatients[0].patients?.first_name} {queuePatients[0].patients?.last_name} - Urgent
              </div>
            </div>
          </div>
          <button className="queue-alert-btn">Start</button>
        </div>
      )}

      {/* Action Buttons */}
      <div className="action-buttons">
        <button className="action-btn primary">+ New Visit</button>
        <button className="action-btn outline">ğŸ“… Calendar</button>
        <button className="action-btn outline">ğŸ‘¥ Patients</button>
      </div>

      {/* Bottom Navigation */}
      <nav className="bottom-nav">
        <div 
          className={`nav-item ${activeNav === 'home' ? 'active' : ''}`}
          onClick={() => setActiveNav('home')}
        >
          <span className="nav-icon">ğŸ </span>
          <span className="nav-label">Home</span>
        </div>
        <div 
          className={`nav-item ${activeNav === 'calendar' ? 'active' : ''}`}
          onClick={() => setActiveNav('calendar')}
        >
          <span className="nav-icon">ğŸ“…</span>
          <span className="nav-label">Calendar</span>
        </div>
        <div 
          className={`nav-item ${activeNav === 'patients' ? 'active' : ''}`}
          onClick={() => setActiveNav('patients')}
        >
          <span className="nav-icon">ğŸ‘¥</span>
          <span className="nav-label">Patients</span>
        </div>
        <div 
          className={`nav-item ${activeNav === 'records' ? 'active' : ''}`}
          onClick={() => setActiveNav('records')}
        >
          <span className="nav-icon">ğŸ“</span>
          <span className="nav-label">Records</span>
        </div>
        <div 
          className={`nav-item ${activeNav === 'profile' ? 'active' : ''}`}
          onClick={() => setActiveNav('profile')}
        >
          <span className="nav-icon">ğŸ‘¤</span>
          <span className="nav-label">Profile</span>
        </div>
      </nav>
    </div>
  )
}
